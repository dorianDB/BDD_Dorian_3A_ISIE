#Ajout de la table Disponibilite
CREATE TABLE Disponibilite (
    ID_Disponibilite INT PRIMARY KEY NOT NULL AUTO_INCREMENT,
    ID_Materiel INT,
    DateDebut DATE,
    DateFin DATE,
    FOREIGN KEY (ID_Materiel) REFERENCES Materiel(ID_Materiel)
);

#Ajout de la colonne ID_Disponibilite dans la table Reservation
ALTER TABLE Reservation
ADD COLUMN ID_Disponibilite INT,
ADD FOREIGN KEY (ID_Disponibilite) REFERENCES Disponibilite(ID_Disponibilite);


#Déclencheur avant l'insertion pour vérifier la disponibilité du matériel
DELIMITER //

CREATE TRIGGER Before_Reservation_Insert
BEFORE INSERT ON Reservation
FOR EACH ROW
BEGIN
    DECLARE Availability_Count INT;
    SET Availability_Count = (
        SELECT COUNT(*)
        FROM Disponibilite
        WHERE ID_Materiel = NEW.Materiel_ID
        AND NEW.DateDebutReservation BETWEEN DateDebut AND DateFin
        AND NEW.DateFinReservation BETWEEN DateDebut AND DateFin
    );
    IF Availability_Count = 0 THEN
        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Le matériel n''est pas disponible pendant cette période.';
    END IF;
END//

DELIMITER ;
